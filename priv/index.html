<!DOCTYPE html>
<html>

 <head>
  <meta charset="UTF-8">
  <title>D3 Websocket</title>
  <style type="text/css">
        .chart rect {
            fill: steelblue;
        }

        .chart text {
            fill: white;
            font: 10px sans-serif;
            text-anchor: end;
        }

  </style>

  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script>
    var demo = (function() {
            var self = {};
            var ws;

            self.key = function(d) {
                return d.pid;
            };

            self.value = function(d) {
                return d.value;
            };

            self.delete_data = function(data){
                d3.select("body").selectAll("p").data(data, self.key).remove();
            };

            self.create_data = function(data) {
                console.log("create_data " + data);
                var width = 420,
                    barHeight = 20;

                var x = d3.scale.linear()
                    .domain([0, d3.max(data, self.value)])
                    .range([0, width]);

                var chart = d3.select(".chart")
                    .attr("width", width)
                    .attr("height", barHeight * data.length);

                var bar = chart.selectAll("g")
                    .data(data, self.key)
                    .enter().append("g")
                    .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

                bar.append("rect")
                    .attr("width", function(d) { return x(d.value); })
                    .attr("height", barHeight - 1);

                bar.append("text")
                    .attr("x", function(d) { return x(d.value) - 4; })
                    .attr("y", barHeight / 2)
                    .attr("dy", ".35em")
                    .text(function(d) { return d.pid; });
            }

            self.connect = function() {
                ws = new window.WebSocket("ws://" + window.location.host + "/ws");

                ws.onclose = function(){
                    setTimeout(function(){demo.connect();}, 500);
                }

                ws.onmessage = function(e){
                    console.log(e);
                    json = JSON.parse(e.data);
                    self.create_data(json.data);
                }
                return self;
            };

            self.send = function(o){
                ws.send(JSON.stringify(o));
            };

            self.conjure = function(){
                self.connect();
            };

            return self;
    }()); 

    $(document).ready(function(){
            demo.conjure();
            });
  </script>
 </head>

 <body>
<svg class="chart"></svg>
 

  
 </body>

</html>

